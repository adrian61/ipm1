<!DOCTYPE html>
<head>
    <style>
        input:valid {
            border-color: rgb(0, 255, 0);
        }
        input:invalid {
            border-color: rgb(255, 0, 0);
        }
    </style>
    <script>
        const alphabet = "abcdefghijklmnopqrstuvwxyz";
        const bigAlphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"};
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
        function init(){
            var request = window.indexedDB.open("ClientDatabase", 1);
            request.onerror = function(event) {
                alert("Error faced while opening database");
            };
            request.onsuccess = function(event) {
                db = event.target.result;
                db.onerror = function(event) {
                    alert("Database error: " + event.target.errorCode);
                };
                updatetable();
            };

            request.onupgradeneeded = function(event) {
                var db = event.target.result;
                var objectStore = db.createObjectStore("clients", {keyPath: "id", autoIncrement: true});
                objectStore.createIndex("name", "name", {unique: false});
                objectStore.createIndex("surname", "surname", {unique: false});
                objectStore.createIndex("email", "email", {unique: false});
                objectStore.createIndex("address", "address", {unique: false});
                objectStore.createIndex("city", "city", {unique: false});
                objectStore.createIndex("zip", "zip", {unique: false});
                objectStore.createIndex("nip", "nip", {unique: false});
                objectStore.createIndex("company", "company", {unique: false});
                objectStore.createIndex("id_card", "id_card", {unique: false});
                objectStore.createIndex("phone", "phone", {unique: false});
                objectStore.transaction.oncomplete = function(event) {

                };
            };

            document.getElementById('addClientForm').onsubmit = function(e) {
                e.preventDefault();
                var bid = document.getElementById('idInput').value;
                var bname = document.getElementById('nameInput').value;
                var bsurname = document.getElementById('surnameInput').value;
                var bemail = document.getElementById('emailInput').value;
                var baddress = document.getElementById('addressInput').value;
                var bcity = document.getElementById('cityInput').value;
                var bzip = document.getElementById('zipInput').value;
                var bnip = document.getElementById('nipInput').value;
                var bcompany = document.getElementById('companyInput').value;
                var bid_card = document.getElementById('idCardInput').value;
                var bphone = document.getElementById('phoneInput').value;

                if (!bname || !bsurname || !bemail || !baddress || !bcity || !bzip || !bphone) {
                    window.alert("Fill the form correctly!");
                    return;
                }

                if (bid != "") {
                    bid = parseInt(bid);
                    var transaction = db.transaction(["clients"], "readwrite");
                    transaction.objectStore("clients").get(bid).onsuccess = function(event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            const book_item = {
                                id: bid,
                                name: bname,
                                surname: bsurname,
                                email: bemail,
                                address: baddress,
                                city: bcity,
                                zip: bzip,
                                nip: bnip,
                                company: bcompany,
                                id_card: bid_card,
                                phone: bphone
                            }
                            var id_del = bid;
                            var transaction = db.transaction(["clients"], "readwrite");
                            var request = transaction.objectStore("clients").delete(id_del);
                            var transaction = db.transaction(["clients"], "readwrite");
                            transaction.oncomplete = function(event) {
                            };
                            transaction.onerror = function(event){
                            };
                            var clientsObjectStore = transaction.objectStore("clients");
                            var request = clientsObjectStore.add(book_item);
                            request.onsuccess = function(event){
                                updatetable();
                            };
                        } else {
                            window.alert("Taki rekord nie istnieje.");
                        }
                    };
                } else {
                    const book_item = {
                        name: bname,
                        surname: bsurname,
                        email: bemail,
                        address: baddress,
                        city: bcity,
                        zip: bzip,
                        nip: bnip,
                        company: bcompany,
                        id_card: bid_card,
                        phone: bphone
                    }
                    var transaction = db.transaction(["clients"], "readwrite");
                    transaction.oncomplete = function(event) {
                    };
                    transaction.onerror = function(event){
                    };
                    var clientsObjectStore = transaction.objectStore("clients");
                    var request = clientsObjectStore.add(book_item);
                    request.onsuccess = function(event){
                    };
                }
                updatetable();
            }

            function randomText(textArray) {
                var randomIndex = Math.floor(Math.random() * textArray.length);
                var randomElement = textArray[randomIndex];
                return randomElement;
            }

            function generateRandomAddress() {
                var street = ['ul. Wólczańska', 'ul. Racławicka', 'ul. Pabianicka', 'Aleja Politechniki', 'ul. Piotrkowska', 'ul. Narutowicza'];
                var house = Math.floor(Math.random() * 99) + 1 + alphabet[Math.floor(Math.random() * alphabet.length)] + '/' + Math.floor(Math.random() * 9) + 1;
                return randomText(street) + " " + house.toString();
            }

            document.getElementById('generateButton').onclick = function(e) {
                document.getElementById("nameInput").value = randomText(['Zuzanna', 'Julia', 'Antoni', 'Stefan', 'Joszko', 'Zbyszko', 'Hipolit', 'Loen', 'Marcin', 'Adam', 'Piotr', 'Wiktor']);
                document.getElementById("surnameInput").value = randomText(['Wójcik', 'Kowalczyk', 'Woźniak', 'Kowalski', 'Zieliński', 'Duch', 'Szymańczyk', 'Kamińska', 'Lewandowski']);
                document.getElementById("emailInput").value = Math.random().toString(36).substring(2, 5) + Math.random().toString(36).substring(2, 5) + '@gmail.com';
                document.getElementById("addressInput").value = generateRandomAddress();
                document.getElementById("cityInput").value = randomText(['Warszawa', 'Gdańsk', 'Gdynia', 'Sopot', 'Kołobrzeg', 'Łódź', 'Poznań']);
                document.getElementById("zipInput").value = (Math.floor(Math.random() * 89 + 10) + '-' + Math.floor(Math.random() * 899 + 100)).toString();
                document.getElementById("companyInput").value = Math.random().toString(36).substring(2, 10);
                document.getElementById("phoneInput").value = Math.floor(Math.random() * 899 + 100).toString() + '-' + Math.floor(Math.random() * 899 + 100).toString() + '-' + Math.floor(Math.random() * 899 + 100).toString();
                document.getElementById("nipInput").value = Math.floor(Math.random() * 899 + 100).toString() + '-' + Math.floor(Math.random() * 899 + 100).toString() + '-' + Math.floor(Math.random() * 89 + 10).toString() + '-' + Math.floor(Math.random() * 89 + 10).toString();
                document.getElementById("idCardInput").value = bigAlphabet[Math.floor(Math.random() * bigAlphabet.length)] + bigAlphabet[Math.floor(Math.random() * bigAlphabet.length)] + bigAlphabet[Math.floor(Math.random() * bigAlphabet.length)] + Math.floor(Math.random() * 899999 + 100000).toString();
            }


            function getDbObjects(filter = (object) => true) {
                let ret = new Promise((res, rej) => {
                    let objects = [];
                    if (db) {
                        var store = db.transaction(['clients'], 'readonly').objectStore('clients');
                        store.openCursor().onsuccess = (e) => {
                            var c = e.target.result;
                            if (c) {
                                if (filter(c.value)) {
                                    objects.push(c.value);
                                }
                                c.continue();
                            } else {
                                res(objects);
                            }
                        };
                    }
                });
                return ret;
            }

            document.getElementById('TriggerWorker').onclick = function(event) {
                const worker = new Worker(onmessage = function (e) {

                    function changeLetterSize(str) {
                        var s = '';
                        var i = 0;
                        while (i < str.length) {
                            var n = str.charAt(i);
                            if (n == n.toUpperCase()) {
                                n = n.toLowerCase();
                            } else {
                                n = n.toUpperCase();
                            }
                            i += 1;
                            s += n;
                        }
                        return s;
                    }

                    var data = JSON.parse(e.data);
                    Object.keys(data).forEach(function (key) {
                        data[key] = changeLetterSize(data[key]);
                    })

                    self.postMessage(JSON.stringify(data));
                });

                var bname = document.getElementById('nameInput').value;
                var bsurname = document.getElementById('surnameInput').value;
                var bemail = document.getElementById('emailInput').value;
                var baddress = document.getElementById('addressInput').value;
                var bcity = document.getElementById('cityInput').value;
                var bzip = document.getElementById('zipInput').value;
                var bnip = document.getElementById('nipInput').value;
                var bcompany = document.getElementById('companyInput').value;
                var bid_card = document.getElementById('idCardInput').value;
                var bphone = document.getElementById('phoneInput').value;
                const item = {
                    name: bname,
                    surname: bsurname,
                    email: bemail,
                    address: baddress,
                    city: bcity,
                    zip: bzip,
                    nip: bnip,
                    company: bcompany,
                    id_card: bid_card,
                    phone: bphone
                }
                worker.postMessage(JSON.stringify(item));
                worker.addEventListener('message', handleMessageFromWorker);
            }

            function handleMessageFromWorker(e) {
                result = JSON.parse(e.data);
                document.getElementById("nameInput").value = result['name'];
                document.getElementById("surnameInput").value = result['surname'];
                document.getElementById("emailInput").value = result['email'];
                document.getElementById("addressInput").value = result['address'];
                document.getElementById("cityInput").value = result['city'];
                document.getElementById("zipInput").value = result['zip'];
                document.getElementById("companyInput").value = result['company'];
                document.getElementById("phoneInput").value = result['phone'];
                document.getElementById("nipInput").value = result['nip'];
                document.getElementById("idCardInput").value = result['id_card'];
            }

            function updatetable(){
                document.getElementById("clients-table-body").innerHTML = "";
                var request = db.transaction("clients").objectStore("clients").openCursor();
                request.onsuccess = function(event){
                    cursor = event.target.result;

                    if (cursor) {
                        document.getElementById("clients-table-body").innerHTML += "<tr><td>" + cursor.key +
                            "</td><td>" + cursor.value.name
                            + "</td><td>" + cursor.value.surname
                            + "</td><td>" + cursor.value.email
                            + "</td><td>" + cursor.value.address
                            + "</td><td>" + cursor.value.city
                            + "</td><td>" + cursor.value.zip
                            + "</td><td>" + cursor.value.nip
                            + "</td><td>" + cursor.value.company
                            + "</td><td>" + cursor.value.id_card
                            + "</td><td>" + cursor.value.phone
                            + "</td><td><button id=\"delButton\" value=\"" + cursor.key + "\">X</button>"
                            + "</td></tr>";
                        document.getElementById('delButton').onclick = function(e){
                            var id_del = parseInt(document.getElementById('delButton').value);
                            var request = db.transaction(["clients"], "readwrite").objectStore("clients").delete(id_del);
                            document.getElementById('filterInput').value = "";
                            updatetable();
                        }
                    }
                    cursor.continue();
                }
            };
        }

    </script>
</head>

<body onload="init()">

<h1>Clients Database</h1>
<p>
<form id="addClientForm">
    <fieldset id="addForm">
        <legend>Add item</legend>

        <label>ID</label>
        <input id="idInput"><br>
        <small>(Fill up to edit an existing record)</small><br><br>

        <label>Name *</label>
        <input id="nameInput" placeholder="Jan" required><br><br>

        <label>Surname *</label>
        <input id="surnameInput" placeholder="Kowalski" required><br><br>

        <label for="email"> Email: </label>
        <input required type="email" id="email" name="email" placeholder="aa@aa.com"/> <br>

        <label for="address">Address *</label>
        <input required type="text" id="addressInput" id="address" placeholder="Piotrkowska 1"><br><br>

        <label>City *</label>
        <input id="cityInput" placeholder="Łódź" required><br><br>

        <label for="zipcode"> ZIP code: </label>
        <input required type="text" id="zipcode" name="zipcode" pattern="^[0-9]{2}-[0-9]{3}$" placeholder="91-321"><br>

        <label for="nipNumber">NIP number </label>
        <input type="text" id="nipInput" name="nip_number" id="nipNumber" placeholder="123-456-32-18" pattern="((\d{3}[- ]\d{3}[- ]\d{2}[- ]\d{2})|(\d{3}[- ]\d{2}[- ]\d{2}[- ]\d{3}))" title="Polish NIP format"><br><br>

        <label for="companyName">Company name </label>
        <input id="companyInput" placeholder="kis" id="companyName"><br><br>

        <label for="idCard">ID card number </label>
        <input type="text" id="idCardInput" name="id_card"  id="idCard" placeholder="ABC123456" pattern="[A-Z]{3}[0-9]{6}" ><br><br>

        <label for="phoneNumber">Phone number *</label>
        <input required type="text" id="phoneInput" placeholder="123-123-123" id="phoneNumber" name="phone_number" pattern="[0-9]{3}(-)?[0-9]{3}(-)?[0-9]{3}" title="NNN-NNN-NNN or NNNNNNNNN format"><br><br>
        <button type="submit" id="addButton">Add</button>
    </fieldset>
</form>
<button id="generateButton">Generuj dane</button><br>
<button id="TriggerWorker">Uruchom Webworker</button>
</p>
<table id="clients-table">
    <thead>
    <tr><th>ID</th><th>Name</th><th>Surname</th><th>Email</th><th>Address</th><th>City</th><th>Zip Code</th><th>NIP</th><th>Company</th><th>ID Card</th><th>Phone number</th></tr>
    </thead>
    <tbody id="clients-table-body">
    </tbody>
</table>

</body>
</html>